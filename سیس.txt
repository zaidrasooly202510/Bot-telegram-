const express = require('express');
const fetch = require('node-fetch');
const FormData = require('form-data');
const Queue = require('bull');

const app = express();
app.use(express.json());

const botToken = '8038494688:AAFh8AyM1Jv-x717xZXPf7cO1CcuFIJJW48'; // ØªÙˆÚ©Ù† Ø¬Ø¯ÛŒØ¯ Ø´Ù…Ø§
const messageQueue = new Queue('messageQueue');

const ownerId = 7289482843; // Ø¢ÛŒâ€ŒØ¯ÛŒ ØªÙ„Ú¯Ø±Ø§Ù… Ø´Ù…Ø§ (Ø³Ø§Ø²Ù†Ø¯Ù‡ Ø±Ø¨Ø§Øª)

let isBotActive = true; // ÙˆØ¶Ø¹ÛŒØª Ø±Ø¨Ø§Øª (ÙØ¹Ø§Ù„/ØºÛŒØ±ÙØ¹Ø§Ù„)

const responses = {
  '/start': ["Ø³Ù„Ø§Ù…Øª Ú©ÙˆØŸ", "Ú†Ø·ÙˆØ±ÛŒØŸ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒ!"],
  'Ø³Ù„Ø§Ù…': ["Ú†Ù¾ Ø®Ø§Ù†Ø¯Ø§Ù† ØªÙ‡ Ø¨Ú†Ù‡ Ø®Ø±", "Ø³Ù„Ø§Ù…! Ú†Ø·ÙˆØ± Ù‡Ø³ØªÛŒØŸ", "Ø¬ÙˆÙ† ØµØ¯Ù‚Ù‡ Ø³Ù„Ø§Ù…Øª Ø´ÙˆÙ…"],
  'Ø®ÙˆØ¨ÛŒ': ["ØªØ±Ù‡ Ú†ÛŒ", "Ø­Ø§Ù„Øª Ú†Ø·ÙˆØ± Ø§Ø³ØªØŸ"],
  'Ú†Ø·ÙˆØ±ÛŒ': ["Ø®ÙˆØ¨Ù… Ù…Ø±Ø³ÛŒ! ØªÙˆ Ú†Ø·ÙˆØ±ÛŒØŸ", "Ø³Ù„Ø§Ù…! Ù…Ù† Ø®ÙˆØ¨Ù…ØŒ ØªÙˆ Ú†ÛŒØŸ", "Ø­Ø§Ù„Ù… Ø®ÙˆØ¨Ù… Ù…Ú¯Ù… ØµØ­Øª Ø§Ù… Ø®ÙˆØ¨ Ù†ÛŒØ³Øª"],
  'Ø¨ÛŒÙˆ': [
    "Ú¯ÙˆÛŒØªÙ‡ Ø®ÙˆØ±Ø¯ÛŒ Ø¨Ú†ÛŒÙ… Ù…Ù‡ Ø¨ÛŒÙˆ ÛŒØ§Ø¯ Ù†Ø¯Ø§Ø±Ù…", "Ø¯Ù„ Ù…Ù† Ø§Ø² Ù‡Ù…Ú¯ÛŒ Ø³Ø±Ø¯ Ø§Ø³Øª", "Ù…ÛŒÙˆ Ø¨Ø³ Ø®Ù„Ø§Øµ",
    "ØªÙˆ ØºØ§Ù„ Ù…ØºØ§Ù„ Ù†Ú©Ùˆ Ø¨Ø±Ø§Ø¯Ø± Ø¨Ø³ Ø®Ù„Ø§Øµ", "Ø¨Ù‚Ø±Ø§Ù† Ø¬Ø§ÛŒØ¯ÛŒ Ù…Ø§ Ø¨Ø³ Ú©Ùˆ", "ØªØ´Ù†Ø§Ø¨ Ù†Ø±Ùˆ Ø¯Ù„Ø¨Ø± Ø®Ø·Ø± Ø¯Ø± Ú©Ù…ÛŒÙ† Ø§Ø³Øª",
    "Ù‡Ø± Ú©ÛŒ Ù…Ú©ØªØ¨ Ø±ÙØª Ú©Ù†Ø¯Ú©ÛŒ Ø´Ø¯", "Ú¯ Ø´ÙˆÛŒÙ† Ú©Ù†Ø¯Ú©ÛŒ Ù†Ø´ÙˆÛŒÙ†", "Ø¨ÛŒØ®ÛŒ Ø¬Ù…Ø¹ Ú©Ùˆ Ø®Ø± Ù…Ø± ØªÙ‡"
  ],
  'Ø§ÛŒØ¯ÛŒ': ["Ø¨Ø±Ùˆ Ù„ÙˆØ¯Ù‡ Ù„ÙˆØ¯Ù‡ Ù†Ú©Ùˆ", "Ú†Ø·ÙˆØ± Ø¨Ø±Ù…ØŸ Ø¨Ø±Ùˆ Ø®ÙˆØ¯Øª!"],
  'Ø³Ú¯': ["Ø®Ø±", "Ø§ÛŒÙ† Ù†ÙˆØ¹ Ú¯ÙØªØ§Ø± Ù…Ù†Ø§Ø³Ø¨ Ù†ÛŒØ³Øª."],
  'Ù…ÛŒØªÛŒ': ["Ù‡Ø§ Ù…ÛŒØªÙ… Ø¯Ù‡ Ù…Ø´Øª Ù‡Ø§ÛŒØª Ù…ÛŒÚ¯ÛŒØ±ÛŒ", "Ù…ÙˆØ§Ø¸Ø¨ Ø¨Ø§Ø´!"],
  'Ú©Ø´Ù…Ø´': ["Ø§ÛŒÙ‚Ù‡ Ú©Ø´Ù…Ø´ Ù†Ú¯Ùˆ", "Ø¯ÙØ¹Ù‡ Ø¨Ø¹Ø¯ Ø§ÛŒÙ†Ùˆ Ù†Ú¯Ùˆ!"],
  'Ù†Ø®ÙˆØ¯': ["Ø§Ùˆ Ø±Ø§ ØµØ¯Ø§ Ù†Ú©Ù† Ú©Ù‡ Ø¨ÛŒØ§Ø¨Øª Ù…ÛŒâ€ŒÚ©Ù†Ù…", "Ù†Ø®ÙˆØ¯ Ø±Ùˆ ØµØ¯Ø§ Ù†Ø²Ù†!", "Ù‡Ø± Ú©ÛŒ Ø¨Ø±Ù‡ Ø®Ø§Ù†Ù‡ Ø®ÙˆØ¯"],
  'ÙÚ©Ø§Ù‡ÛŒ': ["Ø¨ÛŒØ®ÛŒ Ù„ÙˆØ¯Ù‡ ÙÙ‚Ø¯ Ø¬Ù„Ø§Ù„ÛŒ Ø¨Ø§Ø´Ù…", "Ø§ÛŒÙ† Ú†ÛŒÙ‡ Ù…ÛŒÚ¯ÛŒØŸ"],
  'Ø±Ø¨Ø§Øª': ["Ú†ÛŒ Ù…ÛŒÚ¯ÛŒ Ø§ÛŒÙ„Ø§ÛŒÛŒ"],
  'Ø´Ø¨ Ø®ÙˆØ´': ["Ø§Ø² ØµÙ…ÛŒÙ… Ù‚Ù„Ø¨ Ø´Ø¨Øª Ø®ÙˆØ´ Ù†Ø¨Ø§Ø´Ù‡"],
  'Ø®Ø¯Ø§ÙØ²': ["Ø¨Ù„Ø§ÛŒÙ… Ø¯Ù‡ Ù¾Ø³Øª Ú¯Ù… Ø´Ùˆ"],
  'Ø®Ø¯Ø§Ø­Ø§ÙØ¸': ["Ø®Ø¯Ø§ÙØ² Ù†ÛŒÙ… Ø¬Ø§ÛŒ ðŸ™"],
  'Ù¾Ø³ØªÙ‡': ["Ø¨ÛŒÙ†ÛŒ Ø¢Ø´ Ø§Ø³Øª Ù…Ø«Ù„ Ø®Ø³ØªÙ‡", "Ø¨Ú©Ù†ÛŒØ¯ Ø³Ø± Ø¨Ø³ØªÙ‡"],
  'Ú¯ Ø®ÙˆØ±Ø¯ÛŒ': ["Ú¯ Ø§Ú¯Ø± Ø®ÙˆØ±Ø¯Ù†ÛŒ Ù…ÛŒØ¨ÙˆØ¯ Ø¬ÛŒÙ‡ÙˆÙ† ÙˆÙ‚Øª Ø®ÙˆØ±Ø¯Ù‡ Ø¨ÙˆØ¯"],
  'Ø±Ù„ Ù¾ÛŒ': ["Ù‚ÙˆØ§Ø±Ù‡ ØªÙ‡ Ø³ÛŒÙ„ Ú©Ùˆ Ø¨ÛŒ Ø¹Ù‚Ù„"],
  '.': ["Ù†Ù‚Ø·Ù‡ Ù†Ø²Ù† Ú©ÙˆÙ„ Ù…Ø¹Ù„ÙˆÙ… Ù†Ù…ÛŒØ´ÛŒ"],

  // Ú©Ù„Ù…Ø§Øª Ø¬Ø¯ÛŒØ¯ Ø§Ø¶Ø§ÙÙ‡â€ŒØ´Ø¯Ù‡
  'Ø´Ø¨ÛŒØ±': ["Ø´Ø¨ÛŒØ± Ø®Ø± Ø¨ÙˆØ¯ Ùˆ Ù…ÛŒâ€ŒØ¨Ø§Ø´Ø¯ ðŸ˜"],
  'Ø²ÛŒØ¯': ["Ø¹Ø´Ù‚ Ø§Ø³Øª Ø²ÛŒØ¯ Ø¬Ø§Ù† Ø®Ùˆ â¤ï¸"],
  'Ø¬Ø§Ù†Ù…': ["Ù‚Ù†Ø¯Ù… ÙˆØ­ÛŒØ¯ ØªØ±Ú©ØªÙˆØ± ÙØ¯Ø§ÛŒØª"],
  'Ù…Ø§Ø±Ø§Ù„': ["Ù…ÛŒØ¯Ù‡ Ú¯ÛŒ Ú¯Ú¯ Ø§Ø³Øª Ø¬Ø¹Ø§Ù† ðŸ« â™¥ï¸"]
};

async function postReq(url, fields) {
  const tgFormData = new FormData();
  fields.forEach(obj => Object.entries(obj).forEach(([key, value]) => tgFormData.append(key, value)));

  return await fetch(`https://api.telegram.org/bot${botToken}/${url}`, {
    method: 'POST',
    body: tgFormData,
  });
}

const delay = ms => new Promise(resolve => setTimeout(resolve, ms));

const generateInlineKeyboard = () => ({
  "inline_keyboard": [
    [{ text: "Ú©Ø´Ù…Ø´ Ø¨Ø³ØªÙ‡", callback_data: "mute_group" }, { text: "Ú©Ø´Ù…Ø´ Ø¨Ø§Ø²", callback_data: "unmute_group" }],
    [{ text: "ØªÙ…Ø§Ø³ Ø¨Ø§ Ø³Ø§Ø²Ù†Ø¯Ù‡", url: "https://t.me/zaid_RASOOLY_01" }],
    [{ text: "Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ø±Ø¨Ø§Øª", callback_data: "about_bot" }]
  ]
});

app.get('/', async (req, res) => {
  try {
    const telegramResponse = await postReq("setWebhook", [{ "url": `https://${req.hostname}/hook` }]);
    res.send(`<html><body><h1>Telegram Bot Webhook</h1><p>${await telegramResponse.text()}</p></body></html>`);
  } catch (error) {
    res.status(500).send("Error setting webhook: " + error.message);
  }
});

app.post('/hook', async (req, res) => {
  try {
    const json = req.body;
    await delay(1000);

    if (!json.message) return res.send("ok");

    const rawText = json.message.text;
    const chatId = json.message.chat.id;
    const senderId = json.message.from.id;

    // Ø¯Ø³ØªÙˆØ± "/start"
    if (rawText === "/start") {
      await postReq('sendMessage', [{ chat_id: chatId }, { text: "Ø³Ù„Ø§Ù…! Ø±Ø¨Ø§Øª Ú©Ø´Ù…Ø´ Ø¢Ù…Ø§Ø¯Ù‡ Ø¨Ù‡ Ú©Ø§Ø± Ø§Ø³Øª.", reply_markup: JSON.stringify(generateInlineKeyboard()) }]);
      return res.send("ok");
    }

    // Ø®Ø§Ù…ÙˆØ´ Ùˆ Ø±ÙˆØ´Ù† Ú©Ø±Ø¯Ù† Ø±Ø¨Ø§Øª ÙÙ‚Ø· ØªÙˆØ³Ø· Ø´Ù…Ø§
    if (senderId === ownerId) {
      if (rawText === "Ø®Ø§Ù…ÙˆØ´") {
        isBotActive = false;
        await postReq('sendMessage', [{ chat_id: chatId }, { text: "Ø±Ø¨Ø§Øª Ø®Ø§Ù…ÙˆØ´ Ø´Ø¯. ÙÙ‚Ø· Ø´Ù…Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¢Ù† Ø±Ø§ Ø±ÙˆØ´Ù† Ú©Ù†ÛŒØ¯." }]);
        return res.send("ok");
      }
      if (rawText === "Ø±ÙˆØ´Ù†") {
        isBotActive = true;
        await postReq('sendMessage', [{ chat_id: chatId }, { text: "Ø±Ø¨Ø§Øª Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø±ÙˆØ´Ù† Ø´Ø¯ Ùˆ Ø¢Ù…Ø§Ø¯Ù‡ Ø¨Ù‡ Ú©Ø§Ø± Ø§Ø³Øª." }]);
        return res.send("ok");
      }
    }

    // Ø§Ú¯Ø± Ø±Ø¨Ø§Øª Ø®Ø§Ù…ÙˆØ´ Ø¨Ø§Ø´Ø¯ØŒ Ø¨Ù‡ Ù‡ÛŒÚ† Ù¾ÛŒØ§Ù…ÛŒ Ù¾Ø§Ø³Ø® Ù†Ø¯Ù‡Ø¯
    if (!isBotActive) return res.send("ok");

    const normalizedText = rawText.trim().toLowerCase().replace(/[Ù€ØŒØŸØ›!,.]/g, '').replace(/\s+/g, ' ');
    const responseText = responses[normalizedText];

    if (responseText) {
      messageQueue.add({ chatId, text: responseText[Math.floor(Math.random() * responseText.length)], replyToMessageId: json.message.message_id });
    }

    res.send("ok");
  } catch (error) {
    res.status(500).send("Error processing message: " + error.message);
  }
});

messageQueue.process(async (job) => {
  const { chatId, text, replyToMessageId } = job.data;
  await postReq('sendMessage', [{ chat_id: chatId }, { text, reply_to_message_id: replyToMessageId }]);
});

app.listen(3000, () => console.log('Server is running on port 3000'));